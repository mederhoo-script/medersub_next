{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/mederhoo/vtu/vtu-platform/lib/supabase-admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!\n\n// Client for server-side admin tasks (bypass RLS)\n// Ensure this is only imported in server components/routes\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey)\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;AAIzD,MAAM,gBAAgB,IAAA,gMAAY,EAAC,aAAa"}},
    {"offset": {"line": 143, "column": 0}, "map": {"version":3,"sources":["file:///home/mederhoo/vtu/vtu-platform/app/api/fund/verify/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { supabaseAdmin } from '@/lib/supabase-admin';\nimport axios from 'axios';\n\nconst MONNIFY_API_KEY = process.env.NEXT_PUBLIC_MONNIFY_API_KEY;\nconst MONNIFY_SECRET_KEY = process.env.MONNIFY_SECRET_KEY;\nconst BASE_URL = 'https://sandbox.monnify.com/api/v1'; // Sandbox for testing -> Should be configurable\n\n// Basic Auth for Monnify\nconst getBasicAuthToken = () => {\n    return Buffer.from(`${MONNIFY_API_KEY}:${MONNIFY_SECRET_KEY}`).toString('base64');\n};\n\nexport async function POST(req: Request) {\n    try {\n        const { transactionReference } = await req.json();\n\n        console.log('[VERIFY] Starting verification for ref:', transactionReference);\n        console.log('[VERIFY] API Key present:', !!MONNIFY_API_KEY);\n        console.log('[VERIFY] Secret Key present:', !!MONNIFY_SECRET_KEY);\n\n        if (!transactionReference) {\n            return NextResponse.json({ error: 'Transaction reference required' }, { status: 400 });\n        }\n\n        // 1. Check if transaction already processed\n        const { data: existingTx } = await supabaseAdmin\n            .from('transactions')\n            .select('id')\n            .eq('reference', transactionReference)\n            .single();\n\n        if (existingTx) {\n            return NextResponse.json({ error: 'Transaction already processed' }, { status: 400 });\n        }\n\n        // 2. Verify with Monnify API\n        // First get Access Token\n        const authResponse = await axios.post(\n            `${BASE_URL}/auth/login`,\n            {},\n            {\n                headers: {\n                    Authorization: `Basic ${getBasicAuthToken()}`\n                }\n            }\n        );\n\n        const accessToken = authResponse.data.responseBody.accessToken;\n\n        // Verify Transaction\n        console.log('[VERIFY] Querying Monnify API...');\n        const verifyResponse = await axios.get(\n            `${BASE_URL}/merchant/transactions/query?transactionReference=${transactionReference}`,\n            {\n                headers: {\n                    Authorization: `Bearer ${accessToken}`\n                }\n            }\n        );\n\n        const txData = verifyResponse.data.responseBody;\n\n        // Monnify status: PAID, OVERPAID, PARTIALLY_PAID. We generally accept PAID/OVERPAID.\n        if (txData.paymentStatus !== 'PAID' && txData.paymentStatus !== 'OVERPAID') {\n            return NextResponse.json({ error: 'Transaction not successful', status: txData.paymentStatus }, { status: 400 });\n        }\n\n        // Check amount paid (amountPaid is what we should credit, or payableAmount?)\n        // amountPaid is actual money received.\n        const amountToCredit = Number(txData.amountPaid);\n        const userEmail = txData.customer.email;\n\n        // 3. Find User\n        const { data: userProfile } = await supabaseAdmin\n            .from('profiles')\n            .select('id')\n            .eq('email', userEmail)\n            .single();\n\n        if (!userProfile) {\n            return NextResponse.json({ error: 'User not found for this transaction' }, { status: 404 });\n        }\n\n        const userId = userProfile.id;\n\n        // 4. Credit Wallet\n        const { data: wallet } = await supabaseAdmin\n            .from('wallets')\n            .select('balance')\n            .eq('user_id', userId)\n            .single();\n\n        // If wallet doesn't exist, create it (edge case)\n        let newBalance = amountToCredit;\n        if (wallet) {\n            newBalance += Number(wallet.balance);\n            await supabaseAdmin.from('wallets').update({ balance: newBalance }).eq('user_id', userId);\n        } else {\n            await supabaseAdmin.from('wallets').insert({ user_id: userId, balance: newBalance });\n        }\n\n        // 5. Record Transaction\n        await supabaseAdmin.from('transactions').insert({\n            user_id: userId,\n            type: 'deposit',\n            amount: amountToCredit,\n            charged_amount: amountToCredit,\n            status: 'success',\n            reference: transactionReference,\n            meta: {\n                provider: 'monnify',\n                monnify_ref: txData.transactionReference,\n                payment_method: txData.paymentMethod\n            }\n        });\n\n        return NextResponse.json({ success: true, newBalance });\n\n    } catch (err: any) {\n        console.error('[VERIFY] Error details:', {\n            message: err.message,\n            response: err.response?.data,\n            status: err.response?.status,\n            stack: err.stack\n        });\n\n        const errorMessage = err.response?.data?.responseMessage || err.message || 'Verification failed';\n        return NextResponse.json({ error: errorMessage }, { status: 500 });\n    }\n}\n"],"names":[],"mappings":"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"}}]
}