{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///home/mederhoo/vtu/vtu-platform/utils/pricing.ts"],"sourcesContent":["export function calculateDataProfit(planName: string): number {\n    // Normalize string: remove spaces, lowercase\n    const name = planName.toLowerCase().replace(/\\s/g, '');\n\n    // Extract number and unit\n    const match = name.match(/(\\d+(?:\\.\\d+)?)(mb|gb|tb)/);\n\n    if (!match) return 0; // Default if parsing fails\n\n    const value = parseFloat(match[1]);\n    const unit = match[2];\n\n    // Convert to GB for standardized comparison\n    let sizeInGB = value;\n    if (unit === 'mb') {\n        sizeInGB = value / 1024;\n    } else if (unit === 'tb') {\n        sizeInGB = value * 1024;\n    }\n\n    // Pricing tiers logic\n    if (sizeInGB <= 1) {\n        return 10;\n    } else if (sizeInGB <= 3) {\n        return 20;\n    } else if (sizeInGB <= 5) {\n        return 30;\n    } else if (sizeInGB <= 10) {\n        return 50;\n    } else {\n        return 100; // > 10GB\n    }\n}\n"],"names":[],"mappings":";;;;AAAO,SAAS,oBAAoB,QAAgB;IAChD,6CAA6C;IAC7C,MAAM,OAAO,SAAS,WAAW,GAAG,OAAO,CAAC,OAAO;IAEnD,0BAA0B;IAC1B,MAAM,QAAQ,KAAK,KAAK,CAAC;IAEzB,IAAI,CAAC,OAAO,OAAO,GAAG,2BAA2B;IAEjD,MAAM,QAAQ,WAAW,KAAK,CAAC,EAAE;IACjC,MAAM,OAAO,KAAK,CAAC,EAAE;IAErB,4CAA4C;IAC5C,IAAI,WAAW;IACf,IAAI,SAAS,MAAM;QACf,WAAW,QAAQ;IACvB,OAAO,IAAI,SAAS,MAAM;QACtB,WAAW,QAAQ;IACvB;IAEA,sBAAsB;IACtB,IAAI,YAAY,GAAG;QACf,OAAO;IACX,OAAO,IAAI,YAAY,GAAG;QACtB,OAAO;IACX,OAAO,IAAI,YAAY,GAAG;QACtB,OAAO;IACX,OAAO,IAAI,YAAY,IAAI;QACvB,OAAO;IACX,OAAO;QACH,OAAO,KAAK,SAAS;IACzB;AACJ"}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///home/mederhoo/vtu/vtu-platform/app/api/purchase/route.ts"],"sourcesContent":["import { calculateDataProfit } from '@/utils/pricing';\n\nexport async function POST(req: Request) {\n    try {\n        const body = await req.json();\n        const { userId, serviceType, amount, mobileNumber, serviceID, network, planName } = body;\n\n        console.log('Purchase Request:', { userId, serviceType, amount, mobileNumber, planName });\n\n        if (!userId || !amount || !mobileNumber || !serviceID) {\n            return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });\n        }\n\n        // 0. Check for Maintenance Mode & Markup\n        const { data: settings } = await supabaseAdmin.from('system_settings').select('*');\n        const config = settings?.reduce((acc: any, curr: any) => {\n            acc[curr.key] = curr.value;\n            return acc;\n        }, {}) || {};\n\n        const generalConfig = config.general || {};\n\n        if (generalConfig.maintenance) {\n            return NextResponse.json({ error: 'System is currently under maintenance. Please try again later.' }, { status: 503 });\n        }\n\n        // ... existing serviceKey logic ...\n\n        let markupToApply = 0;\n\n        if (serviceType === 'DATA' && planName) {\n            markupToApply = calculateDataProfit(planName);\n        } else {\n            // Fallback to DB markup for other services or if planName missing\n            const globalMarkup = Number(generalConfig.markup || 0);\n            markupToApply = globalMarkup;\n            // Note: In a real app we might still check specific markup from DB here for non-DATA\n        }\n\n        // Calculate total cost to user (Provider Amount + Markup)\n        // Ensure 'amount' passed from frontend is the BASE amount or TOTAL?\n        // Usually, frontend shows Plan Price. We should charge Plan Price + Markup?\n        // Or is Plan Price already including Markup?\n        // Let's assume 'amount' is what the user expects to pay (Plan Price).\n        // If we want to add a fee ON TOP, we do it here.\n        // For simplicity: Charged Amount = Amount + Markup.\n        const totalCharge = Number(amount) + markupToApply;\n\n        // 1. Check User Balance from WALLETS table\n        const { data: wallet, error: walletError } = await supabaseAdmin\n            .from('wallets')\n            .select('balance')\n            .eq('user_id', userId)\n            .single();\n\n        if (walletError || !wallet) {\n            return NextResponse.json({ error: 'User wallet not found.' }, { status: 404 });\n        }\n\n        if (Number(wallet.balance) < totalCharge) {\n            return NextResponse.json({ error: `Insufficient balance. Required: â‚¦${totalCharge}` }, { status: 400 });\n        }\n\n        // 2. Call Inlomax API (Send the actual cost to provider, not the charged amount)\n        let apiResponse;\n        if (serviceType === 'AIRTIME') {\n            apiResponse = await inlomax.purchaseAirtime(mobileNumber, amount, serviceID);\n        } else if (serviceType === 'DATA') {\n            apiResponse = await inlomax.purchaseData(mobileNumber, serviceID);\n        } else {\n            return NextResponse.json({ error: 'Invalid service type' }, { status: 400 });\n        }\n\n        if (apiResponse.status !== 'success') {\n            console.error('Provider API Failed:', apiResponse); // Log full response\n            let errorMsg = apiResponse.message || 'Provider failed';\n            const lowerMsg = errorMsg.toLowerCase();\n            // Masking provider empty wallet error\n            if (lowerMsg.includes('insufficient funds') || lowerMsg.includes('insuffucient funds')) {\n                errorMsg = 'Service temporarily unavailable. Please try again later.';\n            }\n            return NextResponse.json({ error: errorMsg, debug: apiResponse }, { status: 502 });\n        }\n\n        // 3. Deduct Total Charge from WALLETS\n        const newBalance = Number(wallet.balance) - totalCharge;\n        const { error: updateError } = await supabaseAdmin\n            .from('wallets')\n            .update({ balance: newBalance })\n            .eq('user_id', userId);\n\n        if (updateError) {\n            console.error('CRITICAL: Failed to deduct balance', userId, totalCharge, updateError);\n        }\n\n        // 4. Record Transaction\n        await supabaseAdmin.from('transactions').insert({\n            user_id: userId,\n            type: 'purchase',\n            service_id: serviceID,\n            amount: Number(amount), // Provider cost\n            charged_amount: totalCharge, // What user paid (includes profit)\n            status: 'success',\n            reference: apiResponse.data?.reference || `REF-${Date.now()}`,\n            meta: {\n                service_type: serviceType, // 'AIRTIME' or 'DATA'\n                mobile: mobileNumber,\n                network: network,\n                provider_ref: apiResponse.data?.reference,\n                markup_applied: markupToApply,\n                profit: markupToApply\n            }\n        });\n\n        return NextResponse.json({ success: true, newBalance, message: apiResponse.message });\n\n    } catch (err: any) {\n        console.error('Purchase API Exception:', err);\n        return NextResponse.json({ error: err.message || 'Internal Server Error' }, { status: 500 });\n    }\n}\n"],"names":[],"mappings":"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"}}]
}