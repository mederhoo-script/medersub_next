{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/mederhoo/vtu/vtu-platform/lib/supabase-admin.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!\n\n// Client for server-side admin tasks (bypass RLS)\n// Ensure this is only imported in server components/routes\nexport const supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey)\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;AAIzD,MAAM,gBAAgB,IAAA,gMAAY,EAAC,aAAa"}},
    {"offset": {"line": 143, "column": 0}, "map": {"version":3,"sources":["file:///home/mederhoo/vtu/vtu-platform/lib/inlomax.ts"],"sourcesContent":["import axios from 'axios';\n\nconst INLOMAX_API_KEY = process.env.INLOMAX_API_KEY;\nconst BASE_URL = 'https://inlomax.com/api';\n\nconst api = axios.create({\n    baseURL: BASE_URL,\n    headers: {\n        'Authorization': `Token ${INLOMAX_API_KEY}`,\n        'Content-Type': 'application/json',\n    },\n});\n\nexport interface GenericResponse {\n    status: string;\n    message: string;\n}\n\nexport const inlomax = {\n    getBalance: async () => {\n        try {\n            const { data } = await api.get('/balance');\n            return data;\n        } catch (error: any) {\n            console.error('Inlomax Balance Error:', error.response?.data || error.message);\n            return { status: 'error', message: 'Failed to fetch balance' };\n        }\n    },\n\n    getServices: async () => {\n        try {\n            const { data } = await api.get('/services');\n            return data;\n        } catch (error: any) {\n            console.error('Inlomax Services Error:', error.response?.data || error.message);\n            return { status: 'error', message: 'Failed to fetch services' };\n        }\n    },\n\n    purchaseAirtime: async (mobileNumber: string, amount: number, serviceID: string) => {\n        try {\n            const { data } = await api.post('/airtime', { mobileNumber, amount, serviceID });\n            return data;\n        } catch (error: any) {\n            console.error('Inlomax Airtime Error:', error.response?.data || error.message);\n            // Return the error response properly\n            return error.response?.data || { status: 'error', message: 'Failed to purchase airtime' };\n        }\n    },\n\n    purchaseData: async (mobileNumber: string, serviceID: string) => {\n        try {\n            const { data } = await api.post('/data', { mobileNumber, serviceID });\n            return data;\n        } catch (error: any) {\n            console.error('Inlomax Data Error:', error.response?.data || error.message);\n            return error.response?.data || { status: 'error', message: 'Failed to purchase data' };\n        }\n    },\n\n    validateCable: async (iucNum: string, serviceID: string) => {\n        try {\n            const { data } = await api.post('/validatecable', { iucNum, serviceID });\n            return data;\n        } catch (error: any) {\n            return error.response?.data || { status: 'error', message: 'Failed to validate cable' };\n        }\n    },\n\n    purchaseCable: async (iucNum: string, serviceID: string) => {\n        try {\n            const { data } = await api.post('/subcable', { iucNum, serviceID });\n            return data;\n        } catch (error: any) {\n            return error.response?.data || { status: 'error', message: 'Failed to subscribe cable' };\n        }\n    },\n\n    validateMeter: async (meterNum: string, serviceID: string, meterType: number) => {\n        try {\n            const { data } = await api.post('/validatemeter', { meterNum, serviceID, meterType });\n            return data;\n        } catch (error: any) {\n            return error.response?.data || { status: 'error', message: 'Failed to validate meter' };\n        }\n    },\n\n    payElectricity: async (meterNum: string, serviceID: string, meterType: number, amount: number) => {\n        try {\n            const { data } = await api.post('/payelectric', { meterNum, serviceID, meterType, amount });\n            return data;\n        } catch (error: any) {\n            return error.response?.data || { status: 'error', message: 'Failed to pay electricity' };\n        }\n    },\n\n    getTransaction: async (reference: string) => {\n        try {\n            const { data } = await api.post('/transaction', { reference });\n            return data;\n        } catch (error: any) {\n            return error.response?.data || { status: 'error', message: 'Failed to fetch transaction' };\n        }\n    }\n};\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 292, "column": 0}, "map": {"version":3,"sources":["file:///home/mederhoo/vtu/vtu-platform/app/api/purchase/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { supabaseAdmin } from '@/lib/supabase-admin';\nimport { inlomax } from '@/lib/inlomax';\n\nexport async function POST(req: Request) {\n    try {\n        const body = await req.json();\n        const { userId, serviceType, amount, mobileNumber, serviceID, network } = body;\n\n        console.log('Purchase Request:', { userId, serviceType, amount, mobileNumber });\n\n        if (!userId || !amount || !mobileNumber || !serviceID) {\n            return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });\n        }\n\n        // 0. Check for Maintenance Mode & Markup\n        const { data: settings } = await supabaseAdmin.from('system_settings').select('*');\n        const config = settings?.reduce((acc: any, curr: any) => {\n            acc[curr.key] = curr.value;\n            return acc;\n        }, {}) || {};\n\n        const generalConfig = config.general || {};\n\n        if (generalConfig.maintenance) {\n            return NextResponse.json({ error: 'System is currently under maintenance. Please try again later.' }, { status: 503 });\n        }\n\n        // Fetch Service-Specific Configuration\n        // We assume 'serviceID' for data is roughly mapped to our services table or we use 'network-type' combo\n        // For simplicity, we check if there's a markup for the 'type' keys we seeded: 'mtn-data', 'glo-airtime' etc.\n        // Construct a likely ID based on input.\n        // network is like 'MTN', 'GLO'. serviceType is 'DATA', 'AIRTIME'.\n        // ID format in DB: lowercase(network)-lowercase(serviceType) -> 'mtn-data'\n\n        let serviceKey = '';\n        if (network && serviceType) {\n            serviceKey = `${network.toLowerCase()}-${serviceType.toLowerCase()}`;\n        }\n\n        let specificMarkup = 0;\n        let serviceIsActive = true;\n\n        if (serviceKey) {\n            const { data: serviceConfig } = await supabaseAdmin\n                .from('services')\n                .select('markup, is_active')\n                .eq('id', serviceKey)\n                .single();\n\n            if (serviceConfig) {\n                if (serviceConfig.is_active === false) {\n                    return NextResponse.json({ error: 'This service is currently disabled.' }, { status: 503 });\n                }\n                specificMarkup = Number(serviceConfig.markup || 0);\n            }\n        }\n\n        // Markup Logic: Use Specific if > 0, else use Global\n        // Or should specific ADDS to global? Usually specific OVERRIDES global.\n        // Let's go with: If specific markup is set (even 0), use it?\n        // Or if specific row exists, use it.\n        // Our seeded data has defaults. Let's say if specificMarkup is found, use it.\n        // But what if they want 0 markup?\n        // Let's assume global markup is fallback if service not found in DB.\n\n        const globalMarkup = Number(generalConfig.markup || 0);\n        const finalMarkup = specificMarkup > 0 ? specificMarkup : globalMarkup; // Simple logic: if specific is set, use it.\n\n        // Wait, if specific is 0, do we fallback?\n        // Better: if serviceConfig existed, use its markup (even if 0).\n        // If serviceConfig didn't exist, use global.\n\n        const markupToApply = serviceKey && specificMarkup !== undefined ? specificMarkup : globalMarkup;\n\n        // Calculate total cost to user (Provider Amount + Markup)\n        // Ensure 'amount' passed from frontend is the BASE amount or TOTAL?\n        // Usually, frontend shows Plan Price. We should charge Plan Price + Markup?\n        // Or is Plan Price already including Markup?\n        // Let's assume 'amount' is what the user expects to pay (Plan Price).\n        // If we want to add a fee ON TOP, we do it here.\n        // For simplicity: Charged Amount = Amount + Markup.\n        const totalCharge = Number(amount) + markupToApply;\n\n        // 1. Check User Balance from WALLETS table\n        const { data: wallet, error: walletError } = await supabaseAdmin\n            .from('wallets')\n            .select('balance')\n            .eq('user_id', userId)\n            .single();\n\n        if (walletError || !wallet) {\n            return NextResponse.json({ error: 'User wallet not found.' }, { status: 404 });\n        }\n\n        if (Number(wallet.balance) < totalCharge) {\n            return NextResponse.json({ error: `Insufficient balance. Required: â‚¦${totalCharge}` }, { status: 400 });\n        }\n\n        // 2. Call Inlomax API (Send the actual cost to provider, not the charged amount)\n        let apiResponse;\n        if (serviceType === 'AIRTIME') {\n            apiResponse = await inlomax.purchaseAirtime(mobileNumber, amount, serviceID);\n        } else if (serviceType === 'DATA') {\n            apiResponse = await inlomax.purchaseData(mobileNumber, serviceID);\n        } else {\n            return NextResponse.json({ error: 'Invalid service type' }, { status: 400 });\n        }\n\n        if (apiResponse.status !== 'success') {\n            console.error('Provider API Failed:', apiResponse); // Log full response\n            let errorMsg = apiResponse.message || 'Provider failed';\n            const lowerMsg = errorMsg.toLowerCase();\n            // Masking provider empty wallet error\n            if (lowerMsg.includes('insufficient funds') || lowerMsg.includes('insuffucient funds')) {\n                errorMsg = 'Service temporarily unavailable. Please try again later.';\n            }\n            return NextResponse.json({ error: errorMsg, debug: apiResponse }, { status: 502 });\n        }\n\n        // 3. Deduct Total Charge from WALLETS\n        const newBalance = Number(wallet.balance) - totalCharge;\n        const { error: updateError } = await supabaseAdmin\n            .from('wallets')\n            .update({ balance: newBalance })\n            .eq('user_id', userId);\n\n        if (updateError) {\n            console.error('CRITICAL: Failed to deduct balance', userId, totalCharge, updateError);\n        }\n\n        // 4. Record Transaction\n        await supabaseAdmin.from('transactions').insert({\n            user_id: userId,\n            type: 'purchase',\n            service_id: serviceID,\n            amount: Number(amount), // Provider cost\n            charged_amount: totalCharge, // What user paid (includes profit)\n            status: 'success',\n            reference: apiResponse.data?.reference || `REF-${Date.now()}`,\n            meta: {\n                service_type: serviceType, // 'AIRTIME' or 'DATA'\n                mobile: mobileNumber,\n                network: network,\n                provider_ref: apiResponse.data?.reference,\n                markup_applied: markupToApply,\n                profit: markupToApply\n            }\n        });\n\n        return NextResponse.json({ success: true, newBalance, message: apiResponse.message });\n\n    } catch (err: any) {\n        console.error('Purchase API Exception:', err);\n        return NextResponse.json({ error: err.message || 'Internal Server Error' }, { status: 500 });\n    }\n}\n"],"names":[],"mappings":"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"}}]
}